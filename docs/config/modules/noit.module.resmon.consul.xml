<?xml version="1.0"?>
<section xmlns="http://docbook.org/ns/docbook" version="5">
  <title>consul</title>
  <para>The consul module pulls JSON stats from Hashicorp Consul health checks</para>
  <variablelist>
    <varlistentry>
      <term>loader</term>
      <listitem>
        <para>lua</para>
      </listitem>
    </varlistentry>
    <varlistentry>
      <term>object</term>
      <listitem>
        <para>noit.module.resmon</para>
      </listitem>
    </varlistentry>
  </variablelist>
  <section>
    <title>Check Configuration</title>
    <variablelist>
      <varlistentry>
        <term>url</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>required</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>default</term>
              <listitem>
                <para>http:///v1/health/state/any</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The Consul health check url to call, see consul docs: https://www.consul.io/docs/agent/http/health.html</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>port</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>default</term>
              <listitem>
                <para>8500</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>\d+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The TCP port can be specified to overide the default of 8500.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>check_name</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The name of the Consul check.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>service_name</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The Consul service name to check.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>consul_dc</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The UserSpecifiedConsulDC to filter to.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>service_blacklist</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>A comma separated list of service names to skip</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>node_blacklist</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>A comma separated list of node names to skip</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>check_name_blacklist</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>A comma separated list of check names to skip</para>
        </listitem>
      </varlistentry>
    </variablelist>
  </section>
  <section>
    <title>Examples</title>
    <example>
      <title>Checking health of consul services</title>
      <para>This example checks the health of consul servers service from the c1.int.foo node.</para>
      <programlisting>
      &lt;noit&gt;
        &lt;modules&gt;
          &lt;loader image="lua" name="lua"&gt;
            &lt;config&gt;&lt;directory&gt;/opt/reconnoiter/libexec/modules-lua/?.lua&lt;/directory&gt;&lt;/config&gt;
          &lt;/loader&gt;
          &lt;module loader="lua" name="consul" object="noit.module.resmon"/&gt;
        &lt;/modules&gt;
        &lt;checks&gt;
            &lt;check uuid="2503f08c-7a0f-11e3-9ba0-7cd1c3dcddf7" target="c1.int.foo" period="60000" timeout="10000" name="test.consul" module="consul"&gt;
             &lt;config&gt;
               &lt;url&gt;http://c1.int.foo:8500/v1/health/service/fabio&lt;/url&gt;
               &lt;port&gt;8500&lt;/port&gt;
               &lt;service_name&gt;fabio&lt;/service_name&gt;
               &lt;check_name&gt;Service 'fabio' check&lt;/check_name&gt;
             &lt;/config&gt;
            &lt;/check&gt;
        &lt;/checks&gt;
      &lt;/noit&gt;
    </programlisting>
    </example>
  </section>
</section>
